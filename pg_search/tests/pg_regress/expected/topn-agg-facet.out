-- Test TopN + Aggregates + Faceting
-- Phase 1: Basic TopN tests with window aggregate detection
CREATE EXTENSION IF NOT EXISTS pg_search;
DROP TABLE IF EXISTS products CASCADE;
-- Setup test data
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    description TEXT,
    category TEXT,
    brand TEXT,
    price NUMERIC,
    rating NUMERIC,
    in_stock BOOLEAN,
    sales INTEGER
);
-- Insert test data
INSERT INTO products (name, description, category, brand, price, rating, in_stock, sales) VALUES
    ('MacBook Pro', 'High-performance laptop for professionals', 'Laptops', 'Apple', 2499, 4.8, true, 150),
    ('Dell XPS 13', 'Compact and powerful ultrabook', 'Laptops', 'Dell', 1299, 4.6, true, 200),
    ('ThinkPad X1', 'Business laptop with great keyboard', 'Laptops', 'Lenovo', 1599, 4.5, true, 180),
    ('HP Spectre', 'Stylish convertible laptop', 'Laptops', 'HP', 1399, 4.4, true, 120),
    ('ASUS ROG', 'Gaming laptop with RTX graphics', 'Laptops', 'ASUS', 1899, 4.7, true, 90);
-- Create BM25 index
CREATE INDEX products_idx ON products
USING bm25(id, name, description, category, brand, price, rating, in_stock, sales)
WITH (
    key_field='id',
    text_fields='{
        "name": {},
        "description": {},
        "brand": {"fast": true}
    }',
    numeric_fields='{
        "price": {"fast": true},
        "rating": {"fast": true},
        "sales": {"fast": true}
    }',
    boolean_fields='{
        "in_stock": {"fast": true}
    }'
);
-- Test 1: Basic TopN without window aggregates
\echo 'Test 1: Basic TopN query'
Test 1: Basic TopN query
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Checking 1 RTEs for subquery window functions
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=false, has_search_op=true
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
                                                                         QUERY PLAN                                                                          
-------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    category,
    rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Checking 1 RTEs for subquery window functions
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=false, has_search_op=true
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=false
 id |    name     | category | rating 
----+-------------+----------+--------
  1 | MacBook Pro | Laptops  |    4.8
  5 | ASUS ROG    | Laptops  |    4.7
  3 | ThinkPad X1 | Laptops  |    4.5
(3 rows)

-- Test 2: TopN with COUNT(*) OVER () - Basic window aggregate
\echo 'Test 2: TopN with COUNT(*) OVER () (basic window aggregate)'
Test 2: TopN with COUNT(*) OVER () (basic window aggregate)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                         QUERY PLAN                                                                                                          
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
WARNING:  TopN init: Received 1 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 3: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 1 window aggregates
WARNING:    Target list has 4 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=3
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 3
WARNING:  Computing 1 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Setting window aggregate values in projection: 1 results
WARNING:    Setting te_idx=3: datum=Datum(0x4), const_node addr=0x14903ea78
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 1 results
WARNING:    Setting te_idx=3: datum=Datum(0x4), const_node addr=0x14903ea78
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 1 results
WARNING:    Setting te_idx=3: datum=Datum(0x4), const_node addr=0x14903ea78
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
 id |    name     | rating | total_count 
----+-------------+--------+-------------
  1 | MacBook Pro |    4.8 |           4
  5 | ASUS ROG    |    4.7 |           4
  3 | ThinkPad X1 |    4.5 |           4
(3 rows)

-- Test 3: Multiple window aggregates (COUNT, SUM, AVG)
\echo 'Test 3: Multiple window aggregates in one query'
Test 3: Multiple window aggregates in one query
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER () as total_count,
    SUM(price) OVER () as total_price,
    AVG(rating) OVER () as avg_rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_7)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 6
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_7", missing: None, filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
                                                                                                                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                                                                                                                     
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, price, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Sum":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Avg":{"field":"field_7","missing":null,"filter":null}},"target_entry_index":6,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, price, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Sum":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Avg":{"field":"field_7","missing":null,"filter":null}},"target_entry_index":6,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    rating,
    price,
    COUNT(*) OVER () as total_count,
    SUM(price) OVER () as total_price,
    AVG(rating) OVER () as avg_rating
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_7)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 6
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_7", missing: None, filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
WARNING:  TopN init: Received 3 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 6: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 3 window aggregates
WARNING:    Target list has 7 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:    Looking for window agg at te_idx=6
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 6
WARNING:  Computing 3 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Aggregate type Sum { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Aggregate type Avg { field: "field_7", missing: None, filter: None } not yet implemented
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149051c88
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1490516f8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149051c38
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149051c88
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1490516f8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149051c38
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149051c88
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1490516f8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149051c38
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
 id |    name     | rating | price | total_count | total_price | avg_rating 
----+-------------+--------+-------+-------------+-------------+------------
  1 | MacBook Pro |    4.8 |  2499 |           4 |           0 |          0
  5 | ASUS ROG    |    4.7 |  1899 |           4 |           0 |          0
  3 | ThinkPad X1 |    4.5 |  1599 |           4 |           0 |          0
(3 rows)

-- Test 4: Window aggregate with PARTITION BY (not supported yet, but should extract)
\echo 'Test 4: COUNT with PARTITION BY category'
Test 4: COUNT with PARTITION BY category
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 4 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                       QUERY PLAN                                                                                                                       
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, rating, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 5: Window aggregate with ORDER BY in OVER clause
\echo 'Test 5: SUM with ORDER BY in OVER clause (running total)'
Test 5: SUM with ORDER BY in OVER clause (running total)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    SUM(price) OVER (ORDER BY rating DESC) as running_total
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=Some([OrderByInfo { feature: Field(FieldName("order_col_0")), direction: Asc }]), frame_clause=None
WARNING:  Window function at index 4 extracted but has ORDER BY in OVER clause (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY:
WARNING:    [0] Field(FieldName("order_col_0")) Asc
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 4
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                                                     QUERY PLAN                                                                                                                                                     
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, price, (paradedb.window_func('{"agg_type":{"Sum":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":4,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, price, paradedb.window_func('{"agg_type":{"Sum":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":4,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 6: Window aggregate with ROWS frame
\echo 'Test 6: AVG with ROWS frame'
Test 6: AVG with ROWS frame
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    AVG(rating) OVER (ORDER BY rating DESC ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) as moving_avg
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=Some([OrderByInfo { feature: Field(FieldName("order_col_0")), direction: Asc }]), frame_clause=Some(FrameClause { frame_type: Rows, start_bound: UnboundedPreceding, end_bound: Some(Following(1)) })
WARNING:  Window function at index 3 extracted but has frame clause (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_7)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY:
WARNING:    [0] Field(FieldName("order_col_0")) Asc
WARNING:  FRAME: Rows BETWEEN UnboundedPreceding AND Following(1)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 3
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_7", missing: None, filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                                                                                         QUERY PLAN                                                                                                                                                                                          
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (paradedb.window_func('{"agg_type":{"Avg":{"field":"field_7","missing":null,"filter":null}},"target_entry_index":3,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":{"frame_type":"Rows","start_bound":"UnboundedPreceding","end_bound":{"Following":1}}}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, paradedb.window_func('{"agg_type":{"Avg":{"field":"field_7","missing":null,"filter":null}},"target_entry_index":3,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":{"frame_type":"Rows","start_bound":"UnboundedPreceding","end_bound":{"Following":1}}}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 7: MIN and MAX window aggregates
\echo 'Test 7: MIN and MAX aggregates'
Test 7: MIN and MAX aggregates
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    MIN(price) OVER () as min_price,
    MAX(price) OVER () as max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MIN(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MAX(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: Min { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Max { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                        
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, price, (paradedb.window_func('{"agg_type":{"Min":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":4,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Max":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, price, paradedb.window_func('{"agg_type":{"Min":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":4,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Max":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    rating,
    price,
    MIN(price) OVER () as min_price,
    MAX(price) OVER () as max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MIN(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MAX(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: Min { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Max { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 6 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:  Computing 2 window aggregates
WARNING:  Aggregate type Min { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Aggregate type Max { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x0), const_node addr=0x149841be8
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149842140
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x0), const_node addr=0x149841be8
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149842140
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x0), const_node addr=0x149841be8
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149842140
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
 id |    name     | rating | price | min_price | max_price 
----+-------------+--------+-------+-----------+-----------
  1 | MacBook Pro |    4.8 |  2499 |         0 |         0
  5 | ASUS ROG    |    4.7 |  1899 |         0 |         0
  3 | ThinkPad X1 |    4.5 |  1599 |         0 |         0
(3 rows)

-- Test 8: Window aggregate with FILTER clause
\echo 'Test 8: COUNT with FILTER clause'
Test 8: COUNT with FILTER clause
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    in_stock,
    COUNT(*) FILTER (WHERE in_stock = true) OVER () as in_stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  Window function has FILTER clause - extracting
WARNING:    root is null, storing FILTER as PostgresExpression for later extraction
WARNING:  Window function at index 4 extracted but has FILTER clause (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:    FILTER: WHERE (filter expression)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: Some(PostgresExpression { expr: PostgresExpression { node: PostgresPointer(0x149840478), expr_state: PostgresPointer(0x0) } }) }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                                                                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                                                                                                                                                                           
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, in_stock, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":{"postgres_expression":{"expr":{"node":"{OPEXPR :opno 91 :opfuncid 60 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 8 :vartype 16 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 8 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull false :location -1 :constvalue 1 [ 1 0 0 0 0 0 0 0 ]}) :location -1}"}}}}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, in_stock, paradedb.window_func('{"agg_type":{"CountAny":{"filter":{"postgres_expression":{"expr":{"node":"{OPEXPR :opno 91 :opfuncid 60 :opresulttype 16 :opretset false :opcollid 0 :inputcollid 0 :args ({VAR :varno 1 :varattno 8 :vartype 16 :vartypmod -1 :varcollid 0 :varnullingrels (b) :varlevelsup 0 :varnosyn 1 :varattnosyn 8 :location -1} {CONST :consttype 16 :consttypmod -1 :constcollid 0 :constlen 1 :constbyval true :constisnull false :location -1 :constvalue 1 [ 1 0 0 0 0 0 0 0 ]}) :location -1}"}}}}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 9: COUNT with specific column (not *)
\echo 'Test 9: COUNT(column) instead of COUNT(*)'
Test 9: COUNT(column) instead of COUNT(*)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(brand) OVER () as brand_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(field_5)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: Count { field: "field_5", missing: None, filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                        QUERY PLAN                                                                                                                         
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (paradedb.window_func('{"agg_type":{"Count":{"field":"field_5","missing":null,"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, paradedb.window_func('{"agg_type":{"Count":{"field":"field_5","missing":null,"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 10: Complex PARTITION BY and ORDER BY combination
\echo 'Test 10: Complex window with PARTITION BY and ORDER BY'
Test 10: Complex window with PARTITION BY and ORDER BY
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    brand,
    rating,
    COUNT(*) OVER (PARTITION BY category ORDER BY rating DESC) as category_rank_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=Some([OrderByInfo { feature: Field(FieldName("order_col_0")), direction: Asc }]), frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY:
WARNING:    [0] Field(FieldName("order_col_0")) Asc
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                                                    QUERY PLAN                                                                                                                                                    
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, brand, rating, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, brand, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 11: Window aggregate without ORDER BY on base query
\echo 'Test 11: Window aggregate without ORDER BY or LIMIT'
Test 11: Window aggregate without ORDER BY or LIMIT
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop';
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                      QUERY PLAN                                                                                                       
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Custom Scan (ParadeDB Scan) on public.products
   Output: id, name, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
   Table: products
   Index: products_idx
   Exec Method: NormalScanExecState
   Scores: false
   Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(7 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE description @@@ 'laptop';
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 3: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 1 window aggregates
WARNING:    Target list has 4 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=3
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 3
ERROR:  window_func placeholder executed - custom scan should have intercepted this. JSON: {"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}
-- Test 12: Window aggregate with RANGE frame
\echo 'Test 12: SUM with RANGE frame'
Test 12: SUM with RANGE frame
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    price,
    SUM(price) OVER (ORDER BY rating RANGE BETWEEN 0.5 PRECEDING AND 0.5 FOLLOWING) as range_sum
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=Some([OrderByInfo { feature: Field(FieldName("order_col_0")), direction: Asc }]), frame_clause=Some(FrameClause { frame_type: Range, start_bound: UnboundedPreceding, end_bound: Some(Following(1)) })
WARNING:  Window function at index 4 extracted but has frame clause (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY:
WARNING:    [0] Field(FieldName("order_col_0")) Asc
WARNING:  FRAME: Range BETWEEN UnboundedPreceding AND Following(1)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 4
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                                                                                             QUERY PLAN                                                                                                                                                                                              
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, price, (paradedb.window_func('{"agg_type":{"Sum":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":4,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":{"frame_type":"Range","start_bound":"UnboundedPreceding","end_bound":{"Following":1}}}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, price, paradedb.window_func('{"agg_type":{"Sum":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":4,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":{"frame_type":"Range","start_bound":"UnboundedPreceding","end_bound":{"Following":1}}}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 13: Multiple different PARTITION BY clauses
\echo 'Test 13: Multiple window functions with different partitions'
Test 13: Multiple window functions with different partitions
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    brand,
    rating,
    COUNT(*) OVER (PARTITION BY category) as by_category,
    COUNT(*) OVER (PARTITION BY brand) as by_brand,
    COUNT(*) OVER () as total
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 6 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 6
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #7
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 7
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 8 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
                                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                                              
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, brand, rating, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":6,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":7,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, brand, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":6,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":7,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 14: Window aggregate with GROUPS frame (PG17+)
\echo 'Test 14: COUNT with GROUPS frame'
Test 14: COUNT with GROUPS frame
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER (ORDER BY rating GROUPS BETWEEN 1 PRECEDING AND CURRENT ROW) as group_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=Some([OrderByInfo { feature: Field(FieldName("order_col_0")), direction: Asc }]), frame_clause=Some(FrameClause { frame_type: Groups, start_bound: UnboundedPreceding, end_bound: Some(Following(1)) })
WARNING:  Window function at index 3 extracted but has frame clause (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY:
WARNING:    [0] Field(FieldName("order_col_0")) Asc
WARNING:  FRAME: Groups BETWEEN UnboundedPreceding AND Following(1)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 1 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced 1 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 1 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 1 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 1 window aggregates
                                                                                                                                                                            QUERY PLAN                                                                                                                                                                            
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":{"frame_type":"Groups","start_bound":"UnboundedPreceding","end_bound":{"Following":1}}}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":[{"feature":{"Field":"order_col_0"},"direction":"Asc"}],"frame_clause":{"frame_type":"Groups","start_bound":"UnboundedPreceding","end_bound":{"Following":1}}}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

-- Test 15: TopN with no @@@ operator (should not trigger window function handling)
\echo 'Test 15: Window aggregate without @@@ operator (should use standard WindowAgg)'
Test 15: Window aggregate without @@@ operator (should use standard WindowAgg)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE rating > 4.5
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=1756
WARNING:  expr_contains_operator: Checking node type=T_Var
WARNING:  expr_contains_operator: Unhandled node type=T_Var
WARNING:  expr_contains_operator: Checking node type=T_Const
WARNING:  expr_contains_operator: Unhandled node type=T_Const
WARNING:  query_has_search_operator: Checking 1 RTEs for subqueries
WARNING:  query_has_search_operator: @@@ operator not found
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=false
                        QUERY PLAN                         
-----------------------------------------------------------
 Limit
   Output: id, name, rating, (count(*) OVER (?))
   ->  Sort
         Output: id, name, rating, (count(*) OVER (?))
         Sort Key: products.rating DESC
         ->  WindowAgg
               Output: id, name, rating, count(*) OVER (?)
               ->  Seq Scan on public.products
                     Output: id, name, rating
                     Filter: (products.rating > 4.5)
(10 rows)

SELECT 
    id,
    name,
    rating,
    COUNT(*) OVER () as total_count
FROM products
WHERE rating > 4.5
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=1756
WARNING:  expr_contains_operator: Checking node type=T_Var
WARNING:  expr_contains_operator: Unhandled node type=T_Var
WARNING:  expr_contains_operator: Checking node type=T_Const
WARNING:  expr_contains_operator: Unhandled node type=T_Const
WARNING:  query_has_search_operator: Checking 1 RTEs for subqueries
WARNING:  query_has_search_operator: @@@ operator not found
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=false
 id |    name     | rating | total_count 
----+-------------+--------+-------------
  1 | MacBook Pro |    4.8 |           3
  5 | ASUS ROG    |    4.7 |           3
  2 | Dell XPS 13 |    4.6 |           3
(3 rows)

-- Test 16: Window aggregate with multiple base table columns
\echo 'Test 16: Window aggregate with all result columns'
Test 16: Window aggregate with all result columns
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    brand,
    price,
    rating,
    sales,
    COUNT(*) OVER () as total_count,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 2;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #7
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 7
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #8
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_9)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 8
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 8 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 9 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_9", missing: None, filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                                     QUERY PLAN                                                                                                                                                                                                                                     
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, brand, price, rating, sales, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":7,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Sum":{"field":"field_9","missing":null,"filter":null}},"target_entry_index":8,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, brand, price, rating, sales, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":7,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Sum":{"field":"field_9","missing":null,"filter":null}},"target_entry_index":8,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 2
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    category,
    brand,
    price,
    rating,
    sales,
    COUNT(*) OVER () as total_count,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 2;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #7
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 7
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #8
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_9)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 8
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 8 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 9 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_9", missing: None, filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 7: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 8: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 9 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=7
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 7
WARNING:    Looking for window agg at te_idx=8
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 8
WARNING:  Computing 2 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Aggregate type Sum { field: "field_9", missing: None, filter: None } not yet implemented
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=7: datum=Datum(0x4), const_node addr=0x149074258
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=8: datum=Datum(0x0), const_node addr=0x149074798
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=7: datum=Datum(0x4), const_node addr=0x149074258
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=8: datum=Datum(0x0), const_node addr=0x149074798
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
 id |    name     | category | brand | price | rating | sales | total_count | total_sales 
----+-------------+----------+-------+-------+--------+-------+-------------+-------------
  1 | MacBook Pro | Laptops  | Apple |  2499 |    4.8 |   150 |           4 |           0
  5 | ASUS ROG    | Laptops  | ASUS  |  1899 |    4.7 |    90 |           4 |           0
(2 rows)

-- Test 17: Window aggregate in a subquery (TopN in outer query)
\echo 'Test 17: Subquery with window aggregate, outer LIMIT'
Test 17: Subquery with window aggregate, outer LIMIT
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT * FROM (
    SELECT 
        id,
        name,
        rating,
        price,
        COUNT(*) OVER () as total_count
    FROM products
    WHERE description @@@ 'laptop'
    ORDER BY rating DESC
    LIMIT 5
) sub
ORDER BY price DESC
LIMIT 2;
WARNING:  query_has_window_functions: Checking 1 RTEs for subquery window functions
WARNING:    RTE 0: Found subquery, checking for window functions recursively
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:    RTE 0: Subquery contains window functions!
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is null
WARNING:  query_has_search_operator: Checking 1 RTEs for subqueries
WARNING:    RTE 0: Found subquery, checking recursively
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:    RTE 0: Subquery contains @@@!
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
ERROR:  Should find bm25_index when query has @@@ operator
SELECT * FROM (
    SELECT 
        id,
        name,
        rating,
        price,
        COUNT(*) OVER () as total_count
    FROM products
    WHERE description @@@ 'laptop'
    ORDER BY rating DESC
    LIMIT 5
) sub
ORDER BY price DESC
LIMIT 2;
WARNING:  query_has_window_functions: Checking 1 RTEs for subquery window functions
WARNING:    RTE 0: Found subquery, checking for window functions recursively
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:    RTE 0: Subquery contains window functions!
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is null
WARNING:  query_has_search_operator: Checking 1 RTEs for subqueries
WARNING:    RTE 0: Found subquery, checking recursively
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:    RTE 0: Subquery contains @@@!
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
ERROR:  Should find bm25_index when query has @@@ operator
-- Test 18: Value Facet - Category distribution (like Elasticsearch value facets)
\echo 'Test 18: TopN with category facet (value facet pattern)'
Test 18: TopN with category facet (value facet pattern)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                     
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, rating, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, rating, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    category,
    rating,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY category) as category_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 6 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:  Computing 2 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1490737e8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x149073d40
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1490737e8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x149073d40
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1490737e8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x149073d40
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
 id |    name     | category | rating | total_results | category_count 
----+-------------+----------+--------+---------------+----------------
  1 | MacBook Pro | Laptops  |    4.8 |             4 |              4
  5 | ASUS ROG    | Laptops  |    4.7 |             4 |              4
  3 | ThinkPad X1 | Laptops  |    4.5 |             4 |              4
(3 rows)

-- Test 19: Range Facet - Price buckets (like Elasticsearch range facets)
\echo 'Test 19: TopN with price range buckets'
Test 19: TopN with price range buckets
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    price,
    CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END as price_bucket,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END) as bucket_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                                                                                       QUERY PLAN                                                                                                                                                                                                                                                                                       
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, price, (CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, price, CASE WHEN (price < '1000'::numeric) THEN 'Budget'::text WHEN (price < '1500'::numeric) THEN 'Mid-range'::text ELSE 'Premium'::text END, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 5
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    price,
    CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END as price_bucket,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1000 THEN 'Budget'
        WHEN price < 1500 THEN 'Mid-range'
        ELSE 'Premium'
    END) as bucket_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 7 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:  Computing 2 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149834b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1498350f0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149834b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1498350f0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149834b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1498350f0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149834b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1498350f0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
 id |    name     | price | price_bucket | total_results | bucket_count 
----+-------------+-------+--------------+---------------+--------------
  1 | MacBook Pro |  2499 | Premium      |             4 |            4
  5 | ASUS ROG    |  1899 | Premium      |             4 |            4
  3 | ThinkPad X1 |  1599 | Premium      |             4 |            4
  4 | HP Spectre  |  1399 | Mid-range    |             4 |            4
(4 rows)

-- Test 20: Multi-facet - Brand + Price range (combining multiple facets)
\echo 'Test 20: TopN with multiple facets (brand + price range)'
Test 20: TopN with multiple facets (brand + price range)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    brand,
    price,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    AVG(price) OVER (PARTITION BY brand) as avg_brand_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 6 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_6)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 6
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
                                                                                                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, brand, price, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Avg":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":6,"result_type_oid":701,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, brand, price, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Avg":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":6,"result_type_oid":701,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    brand,
    price,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    AVG(price) OVER (PARTITION BY brand) as avg_brand_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 6 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_6)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 6
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
WARNING:  TopN init: Received 3 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 6: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 3 window aggregates
WARNING:    Target list has 8 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:    Looking for window agg at te_idx=6
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 6
WARNING:  Computing 3 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Aggregate type Avg { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149842480
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149841ed8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x149842430
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149842480
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149841ed8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x149842430
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149842480
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149841ed8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x149842430
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
 id |    name     | brand  | price | total_results | brand_count | avg_brand_price 
----+-------------+--------+-------+---------------+-------------+-----------------
  1 | MacBook Pro | Apple  |  2499 |             4 |           4 |               0
  5 | ASUS ROG    | ASUS   |  1899 |             4 |           4 |               0
  3 | ThinkPad X1 | Lenovo |  1599 |             4 |           4 |               0
(3 rows)

-- Test 21: Facet with aggregates - MIN/MAX price per category
\echo 'Test 21: TopN with MIN/MAX aggregates per category'
Test 21: TopN with MIN/MAX aggregates per category
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    category,
    price,
    COUNT(*) OVER () as total_results,
    MIN(price) OVER (PARTITION BY category) as category_min_price,
    MAX(price) OVER (PARTITION BY category) as category_max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MIN(field_6)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 6 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MAX(field_6)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 6
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Min { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Max { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
                                                                                                                                                                                                                                                                                                                                                           QUERY PLAN                                                                                                                                                                                                                                                                                                                                                           
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, category, price, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Min":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Max":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":6,"result_type_oid":701,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, category, price, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Min":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Max":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":6,"result_type_oid":701,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    category,
    price,
    COUNT(*) OVER () as total_results,
    MIN(price) OVER (PARTITION BY category) as category_min_price,
    MAX(price) OVER (PARTITION BY category) as category_max_price
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MIN(field_6)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 6 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: MAX(field_6)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 6
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 3 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced 3 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 3 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Min { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Max { field: "field_6", missing: None, filter: None }
WARNING:  plan_custom_path: Found 3 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 3 window aggregates
WARNING:  TopN init: Received 3 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 6: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 3 window aggregates
WARNING:    Target list has 8 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:    Looking for window agg at te_idx=6
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 6
WARNING:  Computing 3 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Aggregate type Min { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Aggregate type Max { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149842480
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149841ed8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149842430
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149842480
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149841ed8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149842430
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 3 results
WARNING:    Setting te_idx=6: datum=Datum(0x0), const_node addr=0x149842480
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149841ed8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x149842430
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
 id |    name     | category | price | total_results | category_min_price | category_max_price 
----+-------------+----------+-------+---------------+--------------------+--------------------
  1 | MacBook Pro | Laptops  |  2499 |             4 |                  0 |                  0
  5 | ASUS ROG    | Laptops  |  1899 |             4 |                  0 |                  0
  3 | ThinkPad X1 | Laptops  |  1599 |             4 |                  0 |                  0
(3 rows)

-- Test 22: Boolean facet - In-stock availability
\echo 'Test 22: TopN with boolean facet (in_stock)'
Test 22: TopN with boolean facet (in_stock)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    in_stock,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 4 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                    QUERY PLAN                                                                                                                                                                                                                     
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, in_stock, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, in_stock, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":3,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    in_stock,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #3
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 3
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 4 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 4 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 3: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 6 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=3
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 3
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:  Computing 2 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=3: datum=Datum(0x4), const_node addr=0x149841d68
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1498422a0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=3: datum=Datum(0x4), const_node addr=0x149841d68
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1498422a0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=3: datum=Datum(0x4), const_node addr=0x149841d68
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1498422a0
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
 id |    name     | in_stock | total_results | stock_count 
----+-------------+----------+---------------+-------------
  1 | MacBook Pro | t        |             4 |           4
  5 | ASUS ROG    | t        |             4 |           4
  3 | ThinkPad X1 | t        |             4 |           4
(3 rows)

-- Test 23: Popularity facet - Sales volume buckets
\echo 'Test 23: TopN with sales volume facets'
Test 23: TopN with sales volume facets
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    sales,
    CASE 
        WHEN sales < 100 THEN 'Low'
        WHEN sales < 150 THEN 'Medium'
        ELSE 'High'
    END as sales_volume,
    COUNT(*) OVER () as total_results,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_9)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_9", missing: None, filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                                                                            QUERY PLAN                                                                                                                                                                                                                                                                             
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, sales, (CASE WHEN (sales < 100) THEN 'Low'::text WHEN (sales < 150) THEN 'Medium'::text ELSE 'High'::text END), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Sum":{"field":"field_9","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), rating
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, sales, CASE WHEN (sales < 100) THEN 'Low'::text WHEN (sales < 150) THEN 'Medium'::text ELSE 'High'::text END, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Sum":{"field":"field_9","missing":null,"filter":null}},"target_entry_index":5,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), rating
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    sales,
    CASE 
        WHEN sales < 100 THEN 'Low'
        WHEN sales < 150 THEN 'Medium'
        ELSE 'High'
    END as sales_volume,
    COUNT(*) OVER () as total_results,
    SUM(sales) OVER () as total_sales
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: SUM(field_9)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 5
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Sum { field: "field_9", missing: None, filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 7 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:  Computing 2 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Aggregate type Sum { field: "field_9", missing: None, filter: None } not yet implemented
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149842b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x1498430f0
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149842b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x1498430f0
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x149842b98
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x0), const_node addr=0x1498430f0
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
 id |    name     | sales | sales_volume | total_results | total_sales 
----+-------------+-------+--------------+---------------+-------------
  1 | MacBook Pro |   150 | High         |             4 |           0
  5 | ASUS ROG    |    90 | Low          |             4 |           0
  3 | ThinkPad X1 |   180 | High         |             4 |           0
(3 rows)

-- Test 24: Rating histogram - Rating distribution
\echo 'Test 24: TopN with rating distribution histogram'
Test 24: TopN with rating distribution histogram
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    rating,
    CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END as rating_tier,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END) as tier_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
                                                                                                                                                                                                                                                                                                              QUERY PLAN                                                                                                                                                                                                                                                                                                              
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, rating, (CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text))
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, rating, CASE WHEN (rating >= 4.7) THEN 'Excellent (4.7+)'::text WHEN (rating >= 4.5) THEN 'Very Good (4.5-4.7)'::text WHEN (rating >= 4.0) THEN 'Good (4.0-4.5)'::text ELSE 'Fair (<4.0)'::text END, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":4,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":5,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 5
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    rating,
    CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END as rating_tier,
    COUNT(*) OVER () as total_results,
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN rating >= 4.7 THEN 'Excellent (4.7+)'
        WHEN rating >= 4.5 THEN 'Very Good (4.5-4.7)'
        WHEN rating >= 4.0 THEN 'Good (4.0-4.5)'
        ELSE 'Fair (<4.0)'
    END) as tier_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 5;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #4
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 4
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 5 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #5
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 5
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 2 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 5 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 6 with window_func(json)
WARNING:  planner_hook: Replaced 2 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 2 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 2 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 2 window aggregates
WARNING:  TopN init: Received 2 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 4: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 5: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 2 window aggregates
WARNING:    Target list has 6 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=4
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 4
WARNING:    Looking for window agg at te_idx=5
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 5
WARNING:  Computing 2 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1390d5a18
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1390d5f70
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1390d5a18
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1390d5f70
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1390d5a18
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1390d5f70
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:  Setting window aggregate values in projection: 2 results
WARNING:    Setting te_idx=4: datum=Datum(0x4), const_node addr=0x1390d5a18
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=5: datum=Datum(0x4), const_node addr=0x1390d5f70
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
 id |    name     | rating |     rating_tier     | total_results | tier_count 
----+-------------+--------+---------------------+---------------+------------
  1 | MacBook Pro |    4.8 | Excellent (4.7+)    |             4 |          4
  5 | ASUS ROG    |    4.7 | Excellent (4.7+)    |             4 |          4
  3 | ThinkPad X1 |    4.5 | Very Good (4.5-4.7) |             4 |          4
  4 | HP Spectre  |    4.4 | Good (4.0-4.5)      |             4 |          4
(4 rows)

-- Test 25: Complete faceting scenario - Combining all facet types
\echo 'Test 25: Complete e-commerce faceting (brand, price, rating, stock)'
Test 25: Complete e-commerce faceting (brand, price, rating, stock)
EXPLAIN (COSTS OFF, VERBOSE, TIMING OFF)
SELECT 
    id,
    name,
    brand,
    price,
    rating,
    in_stock,
    -- Overall metrics
    COUNT(*) OVER () as total_results,
    AVG(price) OVER () as avg_price,
    AVG(rating) OVER () as avg_rating,
    -- Brand facets
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    -- Price range facets
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1500 THEN 'Under $1500'
        ELSE '$1500+'
    END) as price_range_count,
    -- Stock facets
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 6
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #7
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 7
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #8
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_7)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 8
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 9 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #9
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 9
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 10 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #10
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 10
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 11 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #11
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 11
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 6 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 8 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 9 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 10 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 11 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 12 with window_func(json)
WARNING:  planner_hook: Replaced 6 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 6 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_7", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 6 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 6 window aggregates
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit
   Output: id, name, brand, price, rating, in_stock, (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":6,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Avg":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":7,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"Avg":{"field":"field_7","missing":null,"filter":null}},"target_entry_index":8,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":9,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":10,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":11,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text)), (CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END)
   ->  Custom Scan (ParadeDB Scan) on public.products
         Output: id, name, brand, price, rating, in_stock, paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":6,"result_type_oid":20,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Avg":{"field":"field_6","missing":null,"filter":null}},"target_entry_index":7,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"Avg":{"field":"field_7","missing":null,"filter":null}},"target_entry_index":8,"result_type_oid":701,"window_spec":{"partition_by":[],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":9,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":10,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), paradedb.window_func('{"agg_type":{"CountAny":{"filter":null}},"target_entry_index":11,"result_type_oid":20,"window_spec":{"partition_by":["partition_col_0"],"order_by":null,"frame_clause":null}}'::text), CASE WHEN (price < '1500'::numeric) THEN 'Under $1500'::text ELSE '$1500+'::text END
         Table: products
         Index: products_idx
         Exec Method: TopNScanExecState
         Scores: false
            TopN Order By: rating desc
            TopN Limit: 3
         Tantivy Query: {"with_index":{"query":{"parse_with_field":{"field":"description","query_string":"laptop","lenient":null,"conjunction_mode":null}}}}
(11 rows)

SELECT 
    id,
    name,
    brand,
    price,
    rating,
    in_stock,
    -- Overall metrics
    COUNT(*) OVER () as total_results,
    AVG(price) OVER () as avg_price,
    AVG(rating) OVER () as avg_rating,
    -- Brand facets
    COUNT(*) OVER (PARTITION BY brand) as brand_count,
    -- Price range facets
    COUNT(*) OVER (PARTITION BY CASE 
        WHEN price < 1500 THEN 'Under $1500'
        ELSE '$1500+'
    END) as price_range_count,
    -- Stock facets
    COUNT(*) OVER (PARTITION BY in_stock) as stock_count
FROM products
WHERE description @@@ 'laptop'
ORDER BY rating DESC
LIMIT 3;
WARNING:  query_has_window_functions: Found window functions in current query
WARNING:  query_has_search_operator: Looking for opno=972100 or 972093
WARNING:  query_has_search_operator: jointree is not null
WARNING:  query_has_search_operator: quals is not null, checking...
WARNING:  expr_contains_operator: Checking node type=T_OpExpr
WARNING:  expr_contains_operator: Found OpExpr with opno=972093
WARNING:  expr_contains_operator: MATCH! Found target operator
WARNING:  query_has_search_operator: Found @@@ in WHERE clause
WARNING:  planner_hook: SELECT query (RTEs=1) - has_window_funcs=true, has_search_op=true
WARNING:  planner_hook: Found window functions in search query - replacing with window_func(json)
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #6
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 6
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #7
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_6)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 7
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=[], order_by=None, frame_clause=None
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #8
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: AVG(field_7)
WARNING:  PARTITION BY: (none - aggregate over entire result set)
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 701
WARNING:  Target Entry Index: 8
WARNING:  ✅ CAN EXECUTE: Yes - will compute at execution time
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 9 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #9
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 9
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 10 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #10
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 10
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Extracted window spec: partition_by=["partition_col_0"], order_by=None, frame_clause=None
WARNING:  Window function at index 11 extracted but has PARTITION BY (not yet executable)
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  EXTRACTED WINDOW FUNCTION #11
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  Aggregate Type: COUNT(*)
WARNING:  PARTITION BY:
WARNING:    [0] partition_col_0
WARNING:  ORDER BY: (none)
WARNING:  FRAME: (default)
WARNING:  Result Type OID: 20
WARNING:  Target Entry Index: 11
WARNING:  ⚠️  CAN EXECUTE: No - extracted but not yet supported
WARNING:     Will fall back to PostgreSQL's WindowAgg if not replaced
WARNING:  ═══════════════════════════════════════════════════════════
WARNING:  planner_hook: Extracted 6 window aggregates
WARNING:  planner_hook: Stored window aggregates in global storage
WARNING:  planner_hook: Replaced WindowFunc at resno 7 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 8 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 9 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 10 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 11 with window_func(json)
WARNING:  planner_hook: Replaced WindowFunc at resno 12 with window_func(json)
WARNING:  planner_hook: Replaced 6 WindowFunc nodes in Query with window_func calls
WARNING:  replace_windowfuncs_recursively: Replaced 6 WindowFunc nodes in current query
WARNING:  plan_custom_path: Extracting window_func calls from processed_tlist
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_6", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: Avg { field: "field_7", missing: None, filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  extract_window_func_calls: Found window aggregate: CountAny { filter: None }
WARNING:  plan_custom_path: Found 6 window aggregates, storing in PrivateData
WARNING:  Initializing scan state with 6 window aggregates
WARNING:  TopN init: Received 6 window aggregates from scan state
WARNING:  inject_score_and_snippet_placeholders: need_scores=false, need_snippets=false, has_window_aggs=true
WARNING:  inject_placeholders: Starting
WARNING:    inject_placeholders: Entry 6: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 7: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 8: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 9: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 10: FuncExpr with funcid=972182
WARNING:    inject_placeholders: Entry 11: FuncExpr with funcid=972182
WARNING:  inject_window_aggregate_placeholders: Processing 6 window aggregates
WARNING:    Target list has 13 entries
WARNING:    window_func_procid = 972182
WARNING:    Looking for window agg at te_idx=6
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 6
WARNING:    Looking for window agg at te_idx=7
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 7
WARNING:    Looking for window agg at te_idx=8
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 8
WARNING:    Looking for window agg at te_idx=9
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 9
WARNING:    Looking for window agg at te_idx=10
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 10
WARNING:    Looking for window agg at te_idx=11
WARNING:      Found TargetEntry: type=T_FuncExpr
WARNING:      Found FuncExpr with funcid=972182
WARNING:      MATCH! Creating Const node
WARNING:  Injected Const node for window aggregate at index 11
WARNING:  Computing 6 window aggregates
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Aggregate type Avg { field: "field_6", missing: None, filter: None } not yet implemented
WARNING:  Aggregate type Avg { field: "field_7", missing: None, filter: None } not yet implemented
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Computing COUNT(*) OVER (): total_count=4
WARNING:  Setting window aggregate values in projection: 6 results
WARNING:    Setting te_idx=9: datum=Datum(0x4), const_node addr=0x1390d0438
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=7: datum=Datum(0x0), const_node addr=0x1390d0398
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=11: datum=Datum(0x4), const_node addr=0x1390d04d8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=10: datum=Datum(0x4), const_node addr=0x1390d0488
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=6: datum=Datum(0x4), const_node addr=0x1390cfe58
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=8: datum=Datum(0x0), const_node addr=0x1390d03e8
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 6 results
WARNING:    Setting te_idx=9: datum=Datum(0x4), const_node addr=0x1390d0438
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=7: datum=Datum(0x0), const_node addr=0x1390d0398
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=11: datum=Datum(0x4), const_node addr=0x1390d04d8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=10: datum=Datum(0x4), const_node addr=0x1390d0488
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=6: datum=Datum(0x4), const_node addr=0x1390cfe58
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=8: datum=Datum(0x0), const_node addr=0x1390d03e8
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:  Setting window aggregate values in projection: 6 results
WARNING:    Setting te_idx=9: datum=Datum(0x4), const_node addr=0x1390d0438
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=7: datum=Datum(0x0), const_node addr=0x1390d0398
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
WARNING:    Setting te_idx=11: datum=Datum(0x4), const_node addr=0x1390d04d8
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=10: datum=Datum(0x4), const_node addr=0x1390d0488
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=6: datum=Datum(0x4), const_node addr=0x1390cfe58
WARNING:    After set: constvalue=Datum(0x4), constisnull=false
WARNING:    Setting te_idx=8: datum=Datum(0x0), const_node addr=0x1390d03e8
WARNING:    After set: constvalue=Datum(0x0), constisnull=false
 id |    name     | brand  | price | rating | in_stock | total_results | avg_price | avg_rating | brand_count | price_range_count | stock_count 
----+-------------+--------+-------+--------+----------+---------------+-----------+------------+-------------+-------------------+-------------
  1 | MacBook Pro | Apple  |  2499 |    4.8 | t        |             4 |         0 |          0 |           4 |                 4 |           4
  5 | ASUS ROG    | ASUS   |  1899 |    4.7 | t        |             4 |         0 |          0 |           4 |                 4 |           4
  3 | ThinkPad X1 | Lenovo |  1599 |    4.5 | t        |             4 |         0 |          0 |           4 |                 4 |           4
(3 rows)

-- Cleanup
DROP TABLE products CASCADE;
